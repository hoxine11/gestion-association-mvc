<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… - Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</title>
    
    <!-- Bootstrap 5 RTL CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts Arabic -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
            min-height: 100vh;
            padding: 20px;
        }

        /* Logo MosquÃ©e */
        .mosque-logo {
            font-size: 60px;
            color: #1e7e34;
        }

        .mosque-logo::before {
            content: "ğŸ•Œ";
        }

        /* Header */
        .dashboard-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-title h1 {
            color: #1e7e34;
            font-size: 2em;
            margin: 0;
            font-weight: 700;
        }

        .btn-back {
            background: linear-gradient(135deg, #1e7e34 0%, #155724 100%);
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
            border: none;
        }

        .btn-back:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(30, 126, 52, 0.5);
            color: white;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, rgba(30, 126, 52, 0.1) 0%, transparent 100%);
            border-radius: 0 0 0 100%;
        }

        .stat-icon {
            font-size: 3em;
            margin-bottom: 10px;
            opacity: 0.8;
        }

        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: #1e7e34;
            margin: 10px 0;
        }

        .stat-label {
            color: #666;
            font-size: 1.1em;
            font-weight: 600;
        }

        .stat-card.members {
            border-right: 4px solid #17a2b8;
        }

        .stat-card.members .stat-icon {
            color: #17a2b8;
        }

        .stat-card.instructors {
            border-right: 4px solid #ffc107;
        }

        .stat-card.instructors .stat-icon {
            color: #ffc107;
        }

        .stat-card.activities {
            border-right: 4px solid #28a745;
        }

        .stat-card.activities .stat-icon {
            color: #28a745;
        }

        .stat-card.subscriptions {
            border-right: 4px solid #dc3545;
        }

        .stat-card.subscriptions .stat-icon {
            color: #dc3545;
        }

        /* Charts Section */
        .charts-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .chart-card h3 {
            color: #1e7e34;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1e7e34;
        }

        /* Recent Activities */
        .recent-activities {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .recent-activities h3 {
            color: #1e7e34;
            font-weight: 700;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1e7e34;
        }

        .activity-item {
            padding: 15px;
            border-right: 3px solid #1e7e34;
            background: #f8f9fa;
            margin-bottom: 10px;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .activity-item:hover {
            background: #e9ecef;
            transform: translateX(-5px);
        }

        .activity-time {
            color: #999;
            font-size: 0.9em;
            display: block;
            margin-top: 5px;
        }

        /* Loading */
        .loading-spinner {
            text-align: center;
            padding: 40px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .dashboard-header {
                flex-direction: column;
                text-align: center;
                gap: 15px;
            }

            .header-title {
                flex-direction: column;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .charts-section {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="dashboard-header">
            <div class="header-title">
                <div class="mosque-logo"></div>
                <div>
                    <h1>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>
                    <p class="text-muted mb-0">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¬Ù…Ø¹ÙŠØ© Ø§Ù„Ù‚Ø±Ø¢Ù†ÙŠØ©</p>
                </div>
            </div>
            <a href="index.html" class="btn-back">
                <i class="bi bi-arrow-left"></i> Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù†Ø¸Ø§Ù…
            </a>
        </div>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card members">
                <div class="stat-icon">
                    <i class="bi bi-people-fill"></i>
                </div>
                <div class="stat-number" id="totalMembers">
                    <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                </div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡</div>
            </div>

            <div class="stat-card instructors">
                <div class="stat-icon">
                    <i class="bi bi-person-badge"></i>
                </div>
                <div class="stat-number" id="totalInstructors">
                    <div class="spinner-border spinner-border-sm text-warning" role="status"></div>
                </div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¹Ù„Ù…ÙŠÙ†</div>
            </div>

            <div class="stat-card activities">
                <div class="stat-icon">
                    <i class="bi bi-calendar-event"></i>
                </div>
                <div class="stat-number" id="totalActivities">
                    <div class="spinner-border spinner-border-sm text-success" role="status"></div>
                </div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯ÙˆØ±Ø§Øª</div>
            </div>

            <div class="stat-card subscriptions">
                <div class="stat-icon">
                    <i class="bi bi-card-checklist"></i>
                </div>
                <div class="stat-number" id="totalSubscriptions">
                    <div class="spinner-border spinner-border-sm text-danger" role="status"></div>
                </div>
                <div class="stat-label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª</div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="charts-section">
            <div class="chart-card">
                <h3><i class="bi bi-pie-chart"></i> ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h3>
                anvas id="activitiesCategoryChart"></canvas>
            </div>

            <div class="chart-card">
                <h3><i class="bi bi-bar-chart"></i> Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª Ø§Ù„Ø´Ù‡Ø±ÙŠØ©</h3>
                anvas id="subscriptionsMonthlyChart"></canvas>
            </div>
        </div>

        <!-- Recent Activities -->
        <div class="recent-activities">
            <h3><i class="bi bi-clock-history"></i> Ø¢Ø®Ø± Ø§Ù„Ø£Ù†Ø´Ø·Ø©</h3>
            <div id="recentActivitiesList">
                <div class="loading-spinner">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                    </div>
                    <p class="mt-3">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø©...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        const API_URL = 'http://127.0.0.1:8000/api';

        // Load Dashboard Data
        async function loadDashboardData() {
            try {
                // Fetch all data
                const [members, instructors, activities, subscriptions] = await Promise.all([
                    fetch(`${API_URL}/members`).then(r => r.json()),
                    fetch(`${API_URL}/instructors`).then(r => r.json()),
                    fetch(`${API_URL}/activities`).then(r => r.json()),
                    fetch(`${API_URL}/subscriptions`).then(r => r.json())
                ]);

                // Update statistics
                updateStatistics(members, instructors, activities, subscriptions);

                // Create charts
                createActivityCategoryChart(activities);
                createSubscriptionsMonthlyChart(subscriptions);

                // Display recent activities
                displayRecentActivities(subscriptions, members, activities);

            } catch (error) {
                console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', error);
                showError();
            }
        }

        // Update Statistics Cards
        function updateStatistics(members, instructors, activities, subscriptions) {
            document.getElementById('totalMembers').textContent = members.length;
            document.getElementById('totalInstructors').textContent = instructors.length;
            document.getElementById('totalActivities').textContent = activities.length;
            document.getElementById('totalSubscriptions').textContent = subscriptions.length;
        }

        // Create Activity Category Chart
        function createActivityCategoryChart(activities) {
            const categories = {};
            activities.forEach(activity => {
                categories[activity.category] = (categories[activity.category] || 0) + 1;
            });

            const ctx = document.getElementById('activitiesCategoryChart').getContext('2d');
            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: Object.keys(categories),
                    datasets: [{
                        data: Object.values(categories),
                        backgroundColor: [
                            '#1e7e34',
                            '#28a745',
                            '#20c997',
                            '#17a2b8',
                            '#ffc107',
                            '#fd7e14'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true,
                            labels: {
                                font: {
                                    family: 'Cairo',
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }

        // Create Subscriptions Monthly Chart
        function createSubscriptionsMonthlyChart(subscriptions) {
            const monthsData = {};
            subscriptions.forEach(sub => {
                const date = new Date(sub.created_at);
                const monthYear = `${date.getMonth() + 1}/${date.getFullYear()}`;
                monthsData[monthYear] = (monthsData[monthYear] || 0) + 1;
            });

            // Sort by date
            const sortedMonths = Object.keys(monthsData).sort((a, b) => {
                const [m1, y1] = a.split('/').map(Number);
                const [m2, y2] = b.split('/').map(Number);
                return (y1 - y2) || (m1 - m2);
            }).slice(-6); // Last 6 months

            const monthNames = ['ÙŠÙ†Ø§ÙŠØ±', 'ÙØ¨Ø±Ø§ÙŠØ±', 'Ù…Ø§Ø±Ø³', 'Ø£Ø¨Ø±ÙŠÙ„', 'Ù…Ø§ÙŠÙˆ', 'ÙŠÙˆÙ†ÙŠÙˆ', 
                               'ÙŠÙˆÙ„ÙŠÙˆ', 'Ø£ØºØ³Ø·Ø³', 'Ø³Ø¨ØªÙ…Ø¨Ø±', 'Ø£ÙƒØªÙˆØ¨Ø±', 'Ù†ÙˆÙÙ…Ø¨Ø±', 'Ø¯ÙŠØ³Ù…Ø¨Ø±'];

            const labels = sortedMonths.map(m => {
                const [month, year] = m.split('/').map(Number);
                return `${monthNames[month - 1]} ${year}`;
            });

            const data = sortedMonths.map(m => monthsData[m]);

            const ctx = document.getElementById('subscriptionsMonthlyChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ø§Ø´ØªØ±Ø§ÙƒØ§Øª',
                        data: data,
                        backgroundColor: 'rgba(30, 126, 52, 0.7)',
                        borderColor: '#1e7e34',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    family: 'Cairo'
                                }
                            }
                        }
                    }
                }
            });
        }

        // Display Recent Activities
        function displayRecentActivities(subscriptions, members, activities) {
            const container = document.getElementById('recentActivitiesList');
            
            if (subscriptions.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù†Ø´Ø·Ø© Ø­Ø¯ÙŠØ«Ø©</div>';
                return;
            }

            // Sort by date (most recent first)
            const sortedSubs = subscriptions.sort((a, b) => 
                new Date(b.created_at) - new Date(a.created_at)
            ).slice(0, 10); // Last 10 activities

            let html = '';
            sortedSubs.forEach(sub => {
                const member = members.find(m => m.id === sub.member_id);
                const activity = activities.find(a => a.id === sub.activity_id);
                
                const date = new Date(sub.created_at);
                const formattedDate = date.toLocaleDateString('ar-DZ', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                html += `
                    <div class="activity-item">
                        <i class="bi bi-check-circle-fill text-success"></i>
                        <strong>${member ? member.name : 'Ø¹Ø¶Ùˆ ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}</strong>
                        Ø§Ø´ØªØ±Ùƒ ÙÙŠ Ø¯ÙˆØ±Ø©
                        <strong>${activity ? activity.name : 'Ø¯ÙˆØ±Ø© ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙØ©'}</strong>
                        <span class="activity-time">${formattedDate}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Show Error Message
        function showError() {
            document.getElementById('statsGrid').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger text-center">
                        <i class="bi bi-exclamation-triangle fs-1"></i>
                        <p class="mt-3">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p>
                    </div>
                </div>
            `;
        }

        // Load data on page load
        window.addEventListener('load', loadDashboardData);
    </script>
</body>
</html>
